
events {
    worker_connections 1024;
}

http {
    # 8.2.3 Header Scrubbing & Timeouts
    server_tokens off; # Hide Nginx version
    client_body_timeout 10s;
    client_header_timeout 10s;
    keepalive_timeout 5s;
    send_timeout 10s;

    upstream ipfs_node {
        server dart_ipfs:8080;
    }

    upstream ipfs_gateway {
        server dart_ipfs:8080; 
        # Note: API and Gateway on same port in dart_ipfs currently? 
        # Checking docker-compose, ports were 4001, 5001, 8080.
        # usually 5001 is API, 8080 is Gateway, 4001 is Swarm.
        # We need to clarify port mapping.
    }

    server {
        listen 8080;
        server_name localhost;

        # Scrub Headers (CVE-2020-35669 mitigation helper)
        proxy_hide_header X-Powered-By;
        proxy_hide_header Server;
        
        # Security Headers
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-Frame-Options "DENY" always;

        location / {
            proxy_pass http://dart_ipfs:8080;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            
            # Remove potentially malicious headers from client
            proxy_set_header Proxy "";
        }
    }

    # API Port (if separate)
    server {
        listen 5001;
        server_name localhost;

        location / {
            proxy_pass http://dart_ipfs:5001;
            
            # Scrict Timeouts for API to prevent Slowloris
            proxy_read_timeout 60s;
            proxy_connect_timeout 5s;
        }
    }
}
