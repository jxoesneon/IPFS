graph TB
    subgraph "Application Layer"
        UserApp["External Application"]
        IPFSNode["IPFSNode<br/>(lib/src/core/ipfs_node/ipfs_node.dart)"]:::core
        IPFSWebNode["IPFSWebNode<br/>(lib/src/core/ipfs_node/ipfs_web_node.dart)"]:::core
    end

    subgraph "Service Layer"
        Gateway["HTTP Gateway Server<br/>(lib/src/services/gateway/)"]:::service
        RPC["RPC API<br/>(lib/src/services/rpc/)"]:::service
        PubSubH["PubSub Handler<br/>(lib/src/core/ipfs_node/pubsub_handler.dart)"]:::service
        IPNSH["IPNS Handler<br/>(lib/src/protocols/ipns/)"]:::service
        DNSLinkH["DNSLink Handler<br/>(lib/src/core/ipfs_node/dns_link_handler.dart)"]:::service
    end

    subgraph "Protocol Layer"
        Bitswap["Bitswap 1.2.0<br/>(lib/src/protocols/bitswap/)"]:::protocol
        DHT["Kademlia / S-Kademlia<br/>(lib/src/protocols/dht/)"]:::protocol
        GraphSync["GraphSync<br/>(lib/src/protocols/graphsync/)"]:::protocol
    end

    subgraph "Network & Transport Layer"
        NH["Network Handler<br/>(lib/src/core/ipfs_node/network_handler.dart)"]:::transport
        RouterI["Router Interface<br/>(lib/src/transport/router_interface.dart)"]:::transport
        Libp2p["Libp2p Router (Native)<br/>(lib/src/transport/libp2p_router.dart)"]:::transport
        AutoNAT["AutoNAT Service<br/>(lib/src/core/ipfs_node/auto_nat_handler.dart)"]:::transport
        MDNS["mDNS Discovery<br/>(lib/src/core/ipfs_node/mdns_handler.dart)"]:::transport
        Relay["Circuit Relay v2<br/>(Relay Protocol)"]:::transport
    end

    subgraph "Storage & IPLD Layer"
        UnixFS["UnixFS Engine<br/>(lib/src/core/unixfs/)"]:::storage
        IPLD["IPLD Handler (CBOR/JSON/PB)<br/>(lib/src/core/ipfs_node/ipld_handler.dart)"]:::storage
        BlockStore["BlockStore<br/>(lib/src/core/data_structures/blockstore.dart)"]:::storage
        Datastore["Datastore (Hive/IDB/Flat-File)<br/>(lib/src/core/storage/)"]:::storage
    end

    subgraph "Security & Utilities"
        Security["Security Manager (Keystore)<br/>(lib/src/core/security/)"]:::utils
        Metrics["Metrics Collector<br/>(lib/src/core/metrics/)"]:::utils
        Logger["Structured Logger<br/>(lib/src/utils/logger.dart)"]:::utils
    end

    %% Key Interactions
    UserApp --> IPFSNode
    IPFSNode --> Gateway & RPC & PubSubH & IPNSH & DNSLinkH
    IPFSNode --> Bitswap & DHT & GraphSync & UnixFS
    
    Bitswap --> BlockStore
    Bitswap --> DHT
    DHT --> NH
    NH --> RouterI
    RouterI --> Libp2p
    
    Libp2p --> AutoNAT & MDNS & Relay
    
    Gateway --> IPLD
    IPLD --> BlockStore
    BlockStore --> Datastore
    
    UnixFS --> IPLD
    
    IPFSNode -.-> Security & Metrics & Logger

    %% Deployment & Infrastructure
    subgraph "Deployment (Docker)"
        Docker["Dockerfile / Compose"]
        Nginx["Nginx Reverse Proxy"]
        Docker --> IPFSNode
        Nginx --> Gateway & RPC
    end

    %% Styling
    classDef core fill:#e1f5fe,stroke:#01579b,stroke-width:3px;
    classDef service fill:#fff9c4,stroke:#fbc02d,stroke-width:2px;
    classDef protocol fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px;
    classDef transport fill:#fce4ec,stroke:#c2185b,stroke-width:2px;
    classDef storage fill:#ede7f6,stroke:#512da8,stroke-width:2px;
    classDef utils fill:#f5f5f5,stroke:#616161,stroke-width:2px;
